<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <title>Lista de Conversas</title>
  </head>

  <body class="bg-gray-900 text-white">
    <div class="flex">
      <aside class="w-1/4 h-screen bg-gray-800 p-4 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div>
            <h1 class="text-2xl font-bold mb-2">Conversas</h1>
            <h2 class="text-lg">Lista de conversas recentes:</h2>
          </div>
          <a href="{% url 'logout' %}" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-md">
            Logout
          </a>
        </div>
        <div id="conversation-buttons" class="flex flex-col gap-4">
          <!-- Os botões das conversas serão inseridos aqui via JavaScript -->
        </div>
      </aside>
      <main class="flex-1 h-screen p-4 flex flex-col ">
        <!-- Conteúdo da conversa selecionada pode ser exibido aqui -->
      </main>
    </div>
  </body>

    <script>
      // Função para redirecionar para a página de conversa
      function formatarData(data) {
        const partes = data.split("T");
        const dataFormatada = partes[0].split("-").reverse().join("/");
        if (partes[1]) {
          return `${dataFormatada} ${partes[1].substring(0, 5)}`;
        } else {
          return dataFormatada;
        }
      }

      async function carregarMensagens(conversation_id) {
          try {
            const response = await fetch(`/conversations/${conversation_id}/`);
            const data_conversation = await response.json();
            const main = document.querySelector("main");
            main.innerHTML = ""; // Limpa o conteúdo anterior
            // Adicionando dados da conversa em um cabeçalho dentro do main
            const headerDiv = document.createElement("div");
            headerDiv.classList.add("w-full", "p-4", "text-white", "rounded", "shadow-md", "mb-4");
            if (data_conversation.status === "CLOSED") {
              headerDiv.classList.add("bg-red-500");
            } else {
              headerDiv.classList.add("bg-blue-500");
            }

            const conversationStatus = document.createElement("p");
            conversationStatus.innerText = `Status da conversa: ${formatarData(data_conversation.status)}`;
            headerDiv.appendChild(conversationStatus);

            const conversationCreatedAt = document.createElement("p");
            conversationCreatedAt.innerText = `Criada em: ${formatarData(data_conversation.created_at)}`;
            headerDiv.appendChild(conversationCreatedAt);

            if (data_conversation.status === "CLOSED") {
              const conversationClosedAt = document.createElement("p");
              conversationClosedAt.innerText = `Fechada em: ${formatarData(data_conversation.updated_at)}`;
              headerDiv.appendChild(conversationClosedAt);
            }

            // Inserindo o cabeçalho no início do main
            main.insertBefore(headerDiv, main.firstChild);
            const containerMessages = document.createElement("div");
            containerMessages.classList.add("flex", "flex-col", "gap-4", "mt-4", "flex-1", "overflow-y-auto");
            main.appendChild(containerMessages);

            // Adicionando as mensagens ao corpo do documento
            data_conversation.messages.forEach((message) => {
              // Cria um bloco de mensagem
              const messageBlock = document.createElement("div");
              messageBlock.classList.add(
              "max-w-md",
              "rounded-lg",
              "px-4",
              "py-2",
              "my-2",
              "shadow-md",
              "text-white"
              );

              // Aplica cores e alinhamento conforme a direção da mensagem
              if (message.direction === "SENT") {
              messageBlock.classList.add("bg-blue-500", "ml-0", "mr-auto");
              } else {
              messageBlock.classList.add("bg-green-500", "ml-auto", "mr-2");
              }

              // Cabeçalho com id e data/hora
              const header = document.createElement("div");
              header.classList.add("flex", "justify-between", "text-sm", "mb-1");

              const messageId = document.createElement("span");
              messageId.innerText = `ID: ${message.id}`;
              header.appendChild(messageId);

              

              // Conteúdo da mensagem
              const content = document.createElement("p");
              content.innerText = message.content;
              content.classList.add("text-base", "mt-1");

              // Exibe a direção e a data/hora da mensagem
              const footerDiv = document.createElement("div");
              footerDiv.classList.add("flex", "justify-between", "items-center", "mt-1");

              const directionTag = document.createElement("p");
              directionTag.innerText = `Direction: ${message.direction}`;
              directionTag.classList.add("text-xs", "text-gray-200");

              const timeSpan = document.createElement("span");
              timeSpan.innerText = formatarData(message.created_at);
              timeSpan.classList.add("text-xs", "text-gray-200");

              footerDiv.appendChild(directionTag);
              footerDiv.appendChild(timeSpan);

              messageBlock.append(header, content, footerDiv);
              containerMessages.appendChild(messageBlock);
            });

            // colocar o scroll no final 
            containerMessages.scrollTop = containerMessages.scrollHeight;

          } catch (error) {
            console.error("Erro ao buscar mensagens:", error);
          }
        }

      async function carregarConversas() {
        try {
          const response = await fetch("/conversations/");
          const conversations = await response.json();
          const container = document.createElement("div");
          container.classList.add("flex", "flex-col", "items-center", "gap-4", "mt-4");

          conversations.forEach((conversation) => {
            const button = document.createElement("button");
            button.innerHTML = `Conversa: ${conversation.id} <br> Status: ${conversation.status}`;
            if (conversation.status === "CLOSED") {
              button.classList.add(
              "w-full",
              "bg-gradient-to-r",
              "from-red-500",
              "to-red-700",
              "text-white",
              "py-2",
              "rounded-md",
              "shadow-lg",
              "hover:from-red-600",
              "hover:to-red-800",
              "transition",
              "duration-300",
              "ease-in-out",
              "transform",
              "hover:scale-105"
              );
            } else {
              button.classList.add(
              "w-full",
              "bg-gradient-to-r",
              "from-blue-500",
              "to-blue-700",
              "text-white",
              "py-2",
              "rounded-md",
              "shadow-lg",
              "hover:from-blue-600",
              "hover:to-blue-800",
              "transition",
              "duration-300",
              "ease-in-out",
              "transform",
              "hover:scale-105"
              );
            }
            button.onclick = () => carregarMensagens(conversation.id);
            container.appendChild(button);
          });

          const conversationButtons = document.getElementById("conversation-buttons");
          conversationButtons.appendChild(container);
        } catch (error) {
          console.error("Erro ao buscar conversas:", error);
        }
      }
      carregarConversas();



    </script>
</html>
